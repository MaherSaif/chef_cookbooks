upstream <%= @full_name %> {
  <% if @app[:haproxy] -%>
  server 127.0.0.1:<%= @node[:haproxy][:listen_port] %>;
  <% else -%>
  server unix:/u/apps/<%= @app_name %>/shared/sockets/unicorn.sock fail_timeout=0;
  <% end -%>
}

server {
  listen 80;
  include /etc/nginx/sites-include/<%= @full_name %>;
  server_name <%= @non_ssl_domains.collect {|domain, _| domain }.join(" ") %>;
}

<% if @ssl_domains -%>
<% @ssl_domains.collect { |domain, _| domain =~ /\*\.(.+)/ ? "#{$1}_wildcard" : domain }.each do |domain| -%>
server {  
  listen 443;
  server_name domain;
  
  ssl on;
  ssl_certificate /etc/ssl_certs/<%= domain %>_combined.crt;
  ssl_certificate_key /etc/ssl_certs/<%= domain %>.key;

  # for PCI compliance
  ssl_protocols SSLv3 TLSv1;
  ssl_ciphers ALL:!ADH:RC4+RSA:+HIGH:+MEDIUM:-LOW:-SSLv2:-EXP;
  
  proxy_set_header X-Forwarded-Proto 'https';
  
  include /etc/nginx/sites-include/<%= @full_name %>;
}
<% end -%>
<% end -%>
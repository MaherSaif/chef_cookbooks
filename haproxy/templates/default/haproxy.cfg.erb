global
  log 10.10.0.13 local1 <%= @config[:http_log] ? "info" : "warning" %>
  maxconn 8000
  user <%= @node[:haproxy][:user] %>
  group <%= @node[:haproxy][:user] %>
  pidfile /var/run/haproxy/<%= @name %>.pid
  stats socket /var/run/haproxy/<%= @name %>.stats level admin

defaults
  log global
  balance leastconn
  option dontlognull
  option redispatch
  option forwardfor except <%= node[:proxy][:vip_prefix] %>.<%= @config[:proxy_vip_octet] %>
  option allbackups
  <% if @config[:http_log] -%>option httplog<% end -%>
  <% if @config[:use_stunnel_ssl] -%>
  option http-server-close
  timeout http-keep-alive 8s
  <% else -%>
  option httpclose
  <% end -%>
  mode http
  retries 3
  contimeout <%= @config.has_key?(:conn_timeout) ? @config[:conn_timeout] : "5s" %>
  clitimeout <%= @config.has_key?(:client_timeout) ? @config[:client_timeout] : "180s" %>
  srvtimeout <%= @config.has_key?(:server_timeout) ? @config[:server_timeout] : "180s" %>
  errorfile 500 /etc/haproxy/500.http
  errorfile 502 /etc/haproxy/500.http
  errorfile 503 /etc/haproxy/500.http

<% @config[:frontends].each do |instance_name, config| -%>
frontend <%= instance_name %> <%= node[:proxy][:vip_prefix] %>.<%= @config[:proxy_vip_octet] %>:80
  
  capture request header X-Forwarded-For len 16
  capture request header Host len 100
  capture response header X-Uuid len 36
  
  <% if @config[:use_stunnel_ssl] -%>
  reqadd X-Forwarded-Proto:\ https if { src <%= node[:proxy][:vip_prefix] %>.<%= @config[:proxy_vip_octet] %>  }
  <% end -%>
  
  <% @config[:proxy_acls].each do |acl| -%>
  <%= acl %>
  <% end -%>
  default_backend  app_hosts

  <% @config[:proxy_backends].each do |name, servers| -%>
  backend <%= name %>
  <% servers.each do |server| -%>
    <%= server %>
  <% end -%>
  <% end %>
  
  <% config[:backends].each do |b_name, b_conf| -%>
  
  backend <%= b_name %>
    <% if @config[:monitoring] %>
    option httpchk HEAD <%= @config[:monitoring][:path] %> HTTP/1.1\r\nHost:\ <%= @config[:monitoring][:host] %>
    <% end -%>
    <% b_conf[:servers].each do |server| %>
    server <%= server.first.gsub("-", "_") %> <%= server.last %>:<%= b_conf[:port] || "80" %> <%= b_conf[:server_options] %> check inter 5000
    <% end -%>
  <% end -%>
listen <%= instance_name %>_admin <%= node[:proxy][:vip_prefix] %>.<%= @config[:proxy_vip_octet] %>:81
  mode http
  stats uri /

<% end -%>
